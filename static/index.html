<!DOCTYPE html>
<html>
<head>
  <title>Sustainability Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f7f9fc;
}

.header {
  background: #1f2937;
  color: white;
  padding: 20px 40px;
}

.panel {
  background: white;
  margin: 20px 40px;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.upload-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.filters {
  display: flex;
  gap: 10px;
  align-items: center;
}

.cards {
  display: flex;
  gap: 20px;
  margin: 20px 40px;
}

.card {
  flex: 1;
  padding: 20px;
  background: white;
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 10px;
  border: 1px solid #eee;
  text-align: center;
}

th {
  background: #f1f5f9;
}

button {
  padding: 8px 14px;
  cursor: pointer;
  border: none;
  background: #2563eb;
  color: white;
  border-radius: 4px;
}

button:hover {
  background: #1d4ed8;
}

button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

button.danger {
  background: #dc2626;
}

#loading {
  text-align: center;
  padding: 15px;
  display: none;
  font-weight: bold;
}

.actions-bar {
  margin: 40px;
  display: flex;
  gap: 15px;
}

  </style>
</head>

<body>

<!-- ================= HEADER ================= -->

<header class="header">
  <h2>ðŸŒ± Sustainability Analytics Dashboard</h2>
</header>


<!-- ================= UPLOAD PANEL ================= -->

<div class="panel">

  <h3>Data Upload</h3>

  <div class="upload-row">

    <input type="file" id="fileInput">
    <button onclick="upload()">Upload Sales Data</button>

    <button class="danger" onclick="resetAll()">
      Reset System
    </button>

  </div>

</div>


<!-- ================= UTILITY PANEL ================= -->

<div class="panel">

  <h3>Utility Bills</h3>

  <div class="upload-row">

    <select id="billType">
      <option value="electricity">Electricity</option>
      <option value="fuel">Fuel</option>
      <option value="courier">Courier</option>
    </select>

    <input type="number" id="billAmount" placeholder="Amount">

    <input type="number" id="billUnits" placeholder="Units">

    <input type="text" id="billRegion" placeholder="Region">

    <input type="month" id="billMonth">

    <button onclick="uploadBill()">Upload Bill</button>

  </div>

</div>


<!-- ================= FILTER BAR ================= -->

<div class="panel filters">

  <label>From:</label>
  <input type="month" id="fromMonth">

  <label>To:</label>
  <input type="month" id="toMonth">

  <label>Category:</label>

  <select id="categoryFilter">
    <option value="">All</option>
    <option value="Apparel">Apparel</option>
    <option value="Electronics">Electronics</option>
  </select>

  <button onclick="applyFilters()">Apply Filters</button>

</div>


<!-- ================= LOADING ================= -->

<div id="loading">Processing data...</div>


<!-- ================= KPI CARDS ================= -->

<div class="cards">

  <div class="card" id="totalCo2">
    Total COâ‚‚: -
  </div>

  <div class="card" id="topProduct">
    Top Product: -
  </div>

  <div class="card" id="totalUnits">
    Total Units: -
  </div>

</div>


<!-- ================= CHARTS ================= -->

<div class="panel">

  <h3>Emission Trends</h3>

  <canvas id="trendChart"></canvas>

</div>


<div class="panel">

  <h3>Utility Emissions</h3>

  <canvas id="billChart"></canvas>

</div>


<div class="panel">

  <h3>Total Company Footprint</h3>

  <canvas id="totalFootprintChart"></canvas>

</div>


<!-- ================= DATA TABLE ================= -->

<div class="panel">

  <h3>Product Emissions</h3>

  <table id="metricsTable">
    <thead>
      <tr>
        <th>Product</th>
        <th>Category</th>
        <th>Units</th>
        <th>Energy COâ‚‚</th>
        <th>Transport COâ‚‚</th>
        <th>Total COâ‚‚</th>
        <th>Sources</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>


<!-- ================= UPLOAD HISTORY ================= -->

<div class="panel">

  <h3>Upload History</h3>

  <table id="uploadTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>File</th>
        <th>Rows</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>


<!-- ================= ACTION BAR ================= -->

<div class="actions-bar">

  <button onclick="downloadPDF()">
  Download PDF
</button>

  <button onclick="downloadExcel()">
  Export Excel
</button>


</div>

<script>

function getChartImages() {

  const charts = {};

  if (trendChart)
    charts.trend = trendChart.toBase64Image();

  if (billChart)
    charts.bill = billChart.toBase64Image();

  if (totalChart)
    charts.total = totalChart.toBase64Image();

  return charts;
}

async function downloadPDF() {

  showLoading();

  const charts = getChartImages();

  const res = await fetch("/export/pdf", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(charts)
  });

  const blob = await res.blob();

  hideLoading();

  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "sustainability_report.pdf";
  a.click();
}


function downloadExcel() {

  window.location.href = "/export/excel";

}

let dashboardState = {
  from: null,
  to: null,
  category: null
};

function showLoading() {
  document.getElementById("loading").style.display = "block";
}

function hideLoading() {
  document.getElementById("loading").style.display = "none";
}


function applyFilters() {

  dashboardState.from =
    document.getElementById("fromMonth").value;

  dashboardState.to =
    document.getElementById("toMonth").value;

  dashboardState.category =
    document.getElementById("categoryFilter").value;

  refreshDashboard();
}


async function resetAll() {

  if (!confirm("This will DELETE ALL DATA. Continue?")) return;

  try {

    const res = await fetch("/reset-all", {
      method: "DELETE"
    });

    if (!res.ok) {
      alert("Reset failed");
      return;
    }

    alert("All data cleared");

    // Reload everything
    location.reload();

  } catch (err) {
    console.error(err);
    alert("Network error");
  }
}

async function refreshWithRetry(retries = 4, delay = 1500) {

  for (let i = 0; i < retries; i++) {

    try {
      await refreshDashboard();

      // Wait for BigQuery sync
      await new Promise(r => setTimeout(r, delay));

      // Check if footprint has data
      const res = await fetch("/total-footprint");
      const json = await res.json();

      if (json.data && json.data.length >= 0) {
        return;
      }

    } catch (err) {
      console.warn("Retry failed", err);
    }
  }

  console.warn("Dashboard refresh delayed");
}

async function refreshDashboard() {

  showLoading();

  await loadMetrics(null);
  await loadUploadHistory();
  await loadTrends();
  await loadBillTrends();
  await loadTotalFootprint();
  await loadCompanyKpis();

  hideLoading();
}

let totalChart = null;

async function loadTotalFootprint() {

  const res = await fetch("/total-footprint");
  const json = await res.json();
  const data = json.data;

  if (!data || data.length === 0) {
  console.log("No footprint data");
  return;
}

  const labels = data.map(d => d.month);

  const total = data.map(d => d.total_co2);
  const product = data.map(d => d.product_co2);
  const utility = data.map(d => d.utility_co2);

  const ctx = document
    .getElementById("totalFootprintChart")
    .getContext("2d");

  if (totalChart) totalChart.destroy();

  totalChart = new Chart(ctx, {
    type: "bar",

    data: {
      labels: labels,

      datasets: [
        {
          label: "Product COâ‚‚",
          data: product,
          stack: "carbon"
        },
        {
          label: "Utility COâ‚‚",
          data: utility,
          stack: "carbon"
        },
        {
          label: "Total COâ‚‚",
          data: total,
          type: "line",
          tension: 0.3
        }
      ]
    },

    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true }
      }
    }
  });
}

let billChart = null;

async function loadBillTrends() {

  const res = await fetch("/bill-insights");
  const json = await res.json();
  const data = json.data;

  if (!data.length) return;

  const months = [...new Set(data.map(d => d.month))];

  const electricity = months.map(m =>
    data
      .filter(d => d.month === m && d.bill_type === "electricity")
      .reduce((a,b)=>a+b.estimated_co2,0)
  );

  const fuel = months.map(m =>
    data
      .filter(d => d.month === m && d.bill_type === "fuel")
      .reduce((a,b)=>a+b.estimated_co2,0)
  );

  const courier = months.map(m =>
    data
      .filter(d => d.month === m && d.bill_type === "courier")
      .reduce((a,b)=>a+b.estimated_co2,0)
  );

  const ctx = document
    .getElementById("billChart")
    .getContext("2d");

  if (billChart) billChart.destroy();

  billChart = new Chart(ctx, {
    type: "bar",

    data: {
      labels: months,

      datasets: [
        {
          label: "Electricity",
          data: electricity,
          backgroundColor: "#4e79a7",
          stack: "bills"
        },
        {
          label: "Fuel",
          data: fuel,
          backgroundColor: "#f28e2b",
          stack: "bills"
        },
        {
          label: "Courier",
          data: courier,
          backgroundColor: "#59a14f",
          stack: "bills"
        }
      ]
    },

    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true }
      }
    }
  });
}

async function loadCompanyKpis() {

  const res = await fetch("/company-kpis");
  const json = await res.json();

  document.getElementById("totalCo2").innerText =
    "Company COâ‚‚: " + json.total_company_co2.toFixed(2);
}


/* ================= TREND CHART ================= */

let trendChart = null;

async function loadTrends() {

  const res = await fetch("/trends");
  const json = await res.json();
  const data = json.data;

  if (!data || data.length === 0) return;

  const labels = data.map(d => d.month);

  const cpu = data.map(d => d.co2_per_unit);

  const avg = cpu.map((v,i,arr)=>{
    if(i<2) return null;
    return ((arr[i]+arr[i-1]+arr[i-2])/3).toFixed(3);
  });

  const ctx = document
    .getElementById("trendChart")
    .getContext("2d");

  if (trendChart) trendChart.destroy();

  trendChart = new Chart(ctx, {

    type: "line",

    data: {
      labels,

      datasets: [
        {
          label: "COâ‚‚ per Unit",
          data: cpu,
          borderColor: "#4e79a7",
          tension: 0.3
        },
        {
          label: "3-Month Avg",
          data: avg,
          borderColor: "#59a14f",
          borderDash: [5,5],
          tension: 0.3
        }
      ]
    },

    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" }
      },
      scales: {
        y: {
          title: {
            display: true,
            text: "COâ‚‚ / Unit"
          }
        }
      }
    }
  });
}


async function uploadBill() {

  showLoading();


  const type = document.getElementById("billType").value;
  const amount = document.getElementById("billAmount").value;
  const units = document.getElementById("billUnits").value;
  const region = document.getElementById("billRegion").value;
  const month = document.getElementById("billMonth").value;

  if (!type || !units || !month) {
    alert("Fill all bill fields");
    hideLoading();
    return;
  }

  const params = new URLSearchParams({
    bill_type: type,
    amount: amount,
    units: units,
    region: region,
    month: month
  });

  try {

    const res = await fetch("/upload-bill?" + params, {
      method: "POST"
    });

    const json = await res.json();

    if (!res.ok) {
      alert("Bill upload failed");
      hideLoading();
      return;
    }

    alert("Bill uploaded");

    await refreshWithRetry();



  } catch (err) {
    console.error(err);
    alert("Network error");
  }
}


/* ================= UPLOAD ================= */

async function upload() {

  showLoading();

  const file = document.getElementById('fileInput').files[0];

  if (!file) {
    alert("Please select a file");
    hideLoading();
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  try {
    const res = await fetch("/upload", {
      method: "POST",
      body: formData
    });

    const result = await res.json();

    if (!res.ok || result.error) {
      alert("Upload failed: " + (result.details || "Unknown error"));
      hideLoading();
      return;
    }

    alert("Upload successful");

    await refreshWithRetry();



  } catch (err) {
    alert("Network error");
    console.error(err);
  }
}


/* ================= METRICS ================= */

async function loadMetrics(since = null) {

  const url = since ? `/metrics?since=${since}` : "/metrics";
  const res = await fetch(url);
  const json = await res.json();
  const data = json.data;

  let totalCo2 = 0;
  let totalUnits = 0;
  let topProduct = null;

  const tbody = document.querySelector("#metricsTable tbody");

  let rowsHtml = "";

  data.forEach(row => {

    totalCo2 += row.total_co2_kg;
    totalUnits += row.total_units_sold;

    if (!topProduct || row.total_co2_kg > topProduct.total_co2_kg) {
      topProduct = row;
    }

    rowsHtml += `
      <tr>
        <td>${row.product_name}</td>
        <td>${row.category}</td>
        <td>${row.total_units_sold}</td>
        <td>${row.energy_co2_kg.toFixed(2)}</td>
        <td>${row.transport_co2_kg.toFixed(2)}</td>
        <td>${row.total_co2_kg.toFixed(2)}</td>
        <td>
          ${row.energy_ref || "-"}<br>
          ${row.transport_ref || "-"}
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = rowsHtml;

  document.getElementById("totalCo2").innerText =
    "Total COâ‚‚: " + totalCo2.toFixed(2);

  document.getElementById("totalUnits").innerText =
    "Total Units: " + totalUnits;

  document.getElementById("topProduct").innerText =
    "Top Product: " + (topProduct ? topProduct.product_name : "-");
}


/* ================= UPLOAD HISTORY ================= */

async function loadUploadHistory() {

  const res = await fetch("/uploads");
  const json = await res.json();
  const data = json.data;

  const tbody = document.querySelector("#uploadTable tbody");

  tbody.innerHTML = "";

  data.forEach(row => {

    const formattedTime = new Date(row.upload_time).toLocaleString();

    tbody.innerHTML += `
      <tr>
        <td>${formattedTime}</td>
        <td>${row.file_name}</td>
        <td>${row.rows_loaded}</td>
        <td>${row.status}</td>
        <td>
          <button onclick="viewSince('${row.upload_time}')">View since</button>
          <button onclick="deleteUpload('${row.upload_id}')"
                  style="margin-left:5px;color:red;">
            Delete
          </button>
        </td>
      </tr>
    `;
  });
}


/* ================= FILTER ================= */

async function viewSince(uploadTime) {

  const sinceDate = new Date(uploadTime)
    .toISOString()
    .split("T")[0];

  document.getElementById("filterBanner").style.display = "block";

  document.getElementById("filterText").innerText =
    "Showing insights since " +
    new Date(uploadTime).toLocaleString();

  await loadMetrics(sinceDate);
}


function resetFilter() {

  document.getElementById("filterBanner").style.display = "none";

  loadMetrics(null);
}


/* ================= DELETE ================= */

async function deleteUpload(uploadId) {

  if (!confirm("Delete this upload?")) return;

  const res = await fetch(`/uploads/${uploadId}`, {
    method: "DELETE"
  });

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  alert("Upload deleted");

  resetFilter();
  await refreshDashboard();

}

/* ================= INIT ================= */

window.onload = async () => {
  await refreshWithRetry();
};

</script>

</body>
</html>
